name: ðŸš€ Advanced Auto Dashboard

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  update-readme:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š Update Dashboard
        run: |
          LC=$(find leetcode -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          PR=$(find í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤ -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          BJ=$(find ë°±ì¤€ -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          TOTAL=$((LC + PR + BJ))

          # ðŸ”¥ dashboard ê´€ë ¨ ì»¤ë°‹, merge ì»¤ë°‹ ì œì™¸
          RECENT=$(git log --pretty=format:"- %s" \
            --no-merges \
            --invert-grep \
            --grep="dashboard" \
            -n 5)

          awk -v lc="$LC" -v pr="$PR" -v bj="$BJ" -v total="$TOTAL" -v recent="$RECENT" '
          BEGIN { in_block=0 }
          /<!-- DASHBOARD-START -->/ {
              print "<!-- DASHBOARD-START -->"
              print "## ðŸ“Š Platform Statistics"
              print ""
              print "| Platform | Count |"
              print "|----------|-------|"
              print "| ðŸŸ¡ LeetCode | " lc " |"
              print "| ðŸ”µ Programmers | " pr " |"
              print "| ðŸŸ¢ Baekjoon | " bj " |"
              print "| ðŸ”¢ **Total** | " total " |"
              print ""
              print "## ðŸ¥‡ Recently Solved (Top 5)"
              print recent
              print ""
              print "<!-- DASHBOARD-END -->"
              in_block=1
              next
          }
          /<!-- DASHBOARD-END -->/ { in_block=0; next }
          !in_block { print }
          ' README.md > tmp.md && mv tmp.md README.md

      - name: ðŸ’¾ Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md
          git diff --cached --quiet || git commit -m "ðŸš€ dashboard auto update [skip ci]"
          git push