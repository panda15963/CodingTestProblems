name: ğŸš€ Advanced Auto Dashboard

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  update-readme:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug folders
        run: |
          echo "ğŸ“‚ ROOT: $(ls -la | grep -E '(í”„ë¡œê·¸ë˜ë¨¸ìŠ¤|ë°±ì¤€|leetcode)' || echo 'none')"
          [ -d "í”„ë¡œê·¸ë˜ë¨¸ìŠ¤" ] && echo "âœ… í”„ë¡œê·¸ë˜ë¨¸ìŠ¤: $(ls í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ | wc -l) files"

      - name: Generate dashboard
        run: |
          # ì¹´ìš´íŠ¸ ê³„ì‚°
          lc_count=$(find leetcode -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l || echo 0)
          pr_count=0
          for dir in í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ programmers Programmers; do
            [ -d "$dir" ] && pr_count=$((pr_count + $(find "$dir" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)))
          done
          bj_count=$(find ë°±ì¤€ baekjoon Baekjoon -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l || echo 0)
          total=$((lc_count + pr_count + bj_count))

          echo "âœ… COUNTS: LC=$lc_count PR=$pr_count BJ=$bj_count TOTAL=$total"

          # dashboard.md ì™„ì „ echo ë°©ì‹
          > dashboard.md  # íŒŒì¼ ì´ˆê¸°í™”
          echo "## ğŸ“Š Platform Statistics" >> dashboard.md
          echo "" >> dashboard.md
          echo "| Platform | Count |" >> dashboard.md
          echo "|----------|-------|" >> dashboard.md
          echo "| ğŸŸ¡ LeetCode | $lc_count |" >> dashboard.md
          echo "| ğŸ”µ Programmers | $pr_count |" >> dashboard.md
          echo "| ğŸŸ¢ Baekjoon | $bj_count |" >> dashboard.md
          echo "| ğŸ”¢ **Total** | $total |" >> dashboard.md
          echo "" >> dashboard.md
          echo "## ğŸ¥‡ Recently Solved (Top 5)" >> dashboard.md
          echo "" >> dashboard.md
          git log -n 5 --date=short --pretty=format:'- %ad %s' >> dashboard.md 2>/dev/null || echo "No commits" >> dashboard.md

          echo "ğŸ“‹ PREVIEW:"
          cat dashboard.md

      - name: Update README
        run: |
          if ! grep -q "<!-- DASHBOARD-START -->" README.md; then
            echo "âŒ READMEì— DASHBOARD ë§ˆì»¤ ì—†ìŒ"
            exit 1
          fi
          awk '
          /<!-- DASHBOARD-START -->/{while((getline < "dashboard.md")>0) print; next}
          /<!-- DASHBOARD-END -->/{next}
          {print}
          ' README.md > README.new && mv README.new README.md

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "â„¹ï¸ ë³€ê²½ì—†ìŒ"
          else
            git commit -m "ğŸš€ dashboard: LC$lc_count/PR$pr_count/BJ$bj_count"
            git push