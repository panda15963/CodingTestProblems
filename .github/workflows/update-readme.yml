name: Auto Update README Dashboard

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate dashboard
        run: |
          lc_count=$(find leetcode -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          pr_count=$(find programmers -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          bj_count=$(find baekjoon -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          total=$((lc_count + pr_count + bj_count))

          recent=$(git log --since="7 days ago" --name-only --pretty=format: | grep "/" | cut -d/ -f1 | sort | uniq | wc -l)

          echo "## ðŸ“Š Problem Dashboard" > dashboard.md
          echo "" >> dashboard.md
          echo "- ðŸŸ¡ LeetCode: $lc_count" >> dashboard.md
          echo "- ðŸ”µ Programmers: $pr_count" >> dashboard.md
          echo "- ðŸŸ¢ Baekjoon: $bj_count" >> dashboard.md
          echo "" >> dashboard.md
          echo "**Total Problems: $total**" >> dashboard.md
          echo "" >> dashboard.md
          echo "**Solved in last 7 days: $recent**" >> dashboard.md
          echo "" >> dashboard.md
          echo "---" >> dashboard.md
          echo "" >> dashboard.md
          echo "## ðŸ“Œ All Problems" >> dashboard.md
          echo "" >> dashboard.md
          echo "| Platform | Problem | Link |" >> dashboard.md
          echo "|----------|---------|------|" >> dashboard.md

          for dir in $(ls -dt leetcode/* 2>/dev/null); do
            [ -d "$dir" ] && echo "| LeetCode | $(basename "$dir") | [ðŸ”—](./$dir) |" >> dashboard.md
          done

          for dir in $(ls -dt programmers/* 2>/dev/null); do
            [ -d "$dir" ] && echo "| Programmers | $(basename "$dir") | [ðŸ”—](./$dir) |" >> dashboard.md
          done

          for dir in $(ls -dt baekjoon/* 2>/dev/null); do
            [ -d "$dir" ] && echo "| Baekjoon | $(basename "$dir") | [ðŸ”—](./$dir) |" >> dashboard.md
          done

      - name: Insert into README
        run: |
          awk '
          BEGIN{flag=0}
          /<!-- DASHBOARD-START -->/{flag=1; print; system("cat dashboard.md"); next}
          /<!-- DASHBOARD-END -->/{flag=0}
          !flag
          ' README.md > README.new

          mv README.new README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "ðŸ“Š auto: update dashboard"
          git push