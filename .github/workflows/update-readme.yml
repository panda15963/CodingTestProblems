name: ğŸš€ Advanced Auto Dashboard

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  update-readme:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ####################################################
      # ğŸ“Š í†µê³„ + SVG ìƒì„±
      ####################################################

      - name: Generate statistics and charts
        run: |
          mkdir -p assets

          ############################
          # 1ï¸âƒ£ í”Œë«í¼ ì¹´ìš´íŠ¸
          ############################
          lc_count=0
          pr_count=0
          bj_count=0

          [ -d "leetcode" ] && lc_count=$(find leetcode -mindepth 1 -maxdepth 1 -type d | wc -l)
          [ -d "í”„ë¡œê·¸ë˜ë¨¸ìŠ¤" ] && pr_count=$(find í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ -mindepth 1 -maxdepth 1 -type d | wc -l)
          [ -d "ë°±ì¤€" ] && bj_count=$(find ë°±ì¤€ -mindepth 1 -maxdepth 1 -type d | wc -l)

          ############################
          # 2ï¸âƒ£ ë‚œì´ë„ ì§‘ê³„
          ############################
          easy=0
          medium=0
          hard=0

          if [ -d "leetcode" ]; then
            for dir in leetcode/*; do
              if [ -f "$dir/README.md" ]; then
                diff=$(grep -i "Difficulty:" "$dir/README.md" | cut -d: -f2 | xargs)
                case "$diff" in
                  Easy) easy=$((easy+1)) ;;
                  Medium) medium=$((medium+1)) ;;
                  Hard) hard=$((hard+1)) ;;
                esac
              fi
            done
          fi

          diff_total=$((easy + medium + hard))
          [ "$diff_total" -eq 0 ] && diff_total=1

          easy_p=$((easy * 100 / diff_total))
          medium_p=$((medium * 100 / diff_total))
          hard_p=$((hard * 100 / diff_total))

          ############################
          # 3ï¸âƒ£ ìµœê·¼ 5ê°œ
          ############################
          recent_top=$(git log -n 5 --date=short --pretty=format:'- %ad %s' || echo "")

          ############################
          # 4ï¸âƒ£ SVG ë§‰ëŒ€ê·¸ë˜í”„ ìƒì„±
          ############################
          echo '<svg width="500" height="120" xmlns="http://www.w3.org/2000/svg">' > assets/platform_bar_chart.svg
          echo "<text x='10' y='20'>ğŸŸ¡ LeetCode: $lc_count</text>" >> assets/platform_bar_chart.svg
          echo "<text x='10' y='50'>ğŸ”µ Programmers: $pr_count</text>" >> assets/platform_bar_chart.svg
          echo "<text x='10' y='80'>ğŸŸ¢ Baekjoon: $bj_count</text>" >> assets/platform_bar_chart.svg
          echo '</svg>' >> assets/platform_bar_chart.svg

          ############################
          # 5ï¸âƒ£ SVG ì›í˜• ì°¨íŠ¸ ìƒì„±
          ############################
          echo '<svg width="200" height="200" viewBox="0 0 32 32">' > assets/difficulty_pie_chart.svg
          echo "<circle r='16' cx='16' cy='16' fill='transparent' stroke='#2ecc71' stroke-width='32' stroke-dasharray='$easy_p 100'/>" >> assets/difficulty_pie_chart.svg
          echo '</svg>' >> assets/difficulty_pie_chart.svg

          ############################
          # 6ï¸âƒ£ dashboard.md ìƒì„±
          ############################
          echo "## ğŸ“Š Platform Statistics" > dashboard.md
          echo "" >> dashboard.md
          echo "| Platform | Count |" >> dashboard.md
          echo "|----------|-------|" >> dashboard.md
          echo "| ğŸŸ¡ LeetCode | $lc_count |" >> dashboard.md
          echo "| ğŸ”µ Programmers | $pr_count |" >> dashboard.md
          echo "| ğŸŸ¢ Baekjoon | $bj_count |" >> dashboard.md
          echo "" >> dashboard.md
          echo "![Platform Chart](./assets/platform_bar_chart.svg)" >> dashboard.md
          echo "" >> dashboard.md
          echo "![Difficulty Chart](./assets/difficulty_pie_chart.svg)" >> dashboard.md
          echo "" >> dashboard.md
          echo "## ğŸ¥‡ Recently Solved (Top 5)" >> dashboard.md
          echo "" >> dashboard.md
          echo "$recent_top" >> dashboard.md

      ####################################################
      # ğŸ“¥ README ì‚½ì…
      ####################################################

      - name: Insert into README
        run: |
          awk '
          BEGIN{flag=0}
          /<!-- DASHBOARD-START -->/{flag=1; print; system("cat dashboard.md"); next}
          /<!-- DASHBOARD-END -->/{flag=0}
          !flag
          ' README.md > README.new
          mv README.new README.md

      ####################################################
      # ğŸ’¾ Commit
      ####################################################

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md assets
          git diff --cached --quiet || git commit -m "ğŸš€ auto: advanced dashboard"
          git push