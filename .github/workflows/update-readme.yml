name: ðŸš€ Advanced Auto Dashboard

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  update-readme:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ####################################################
      # ðŸ“Š í†µê³„ ìƒì„±
      ####################################################

      - name: Generate statistics
        run: |
          ########################################
          # 1ï¸âƒ£ í”Œëž«í¼ ì¹´ìš´íŠ¸
          ########################################

          lc_count=0
          pr_count=0
          bj_count=0

          [ -d "leetcode" ] && lc_count=$(find leetcode -mindepth 1 -maxdepth 1 -type d | wc -l)
          [ -d "í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤" ] && pr_count=$(find í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤ -mindepth 1 -maxdepth 1 -type d | wc -l)
          [ -d "ë°±ì¤€" ] && bj_count=$(find ë°±ì¤€ -mindepth 1 -maxdepth 1 -type d | wc -l)

          ########################################
          # 2ï¸âƒ£ ìµœê·¼ 5ê°œ
          ########################################

          recent_top=$(git log -n 5 --date=short --pretty=format:'- %ad %s' || echo "")

          ########################################
          # 3ï¸âƒ£ dashboard.md ìƒì„±
          ########################################

          echo "## ðŸ“Š Platform Statistics" > dashboard.md
          echo "" >> dashboard.md
          echo "| Platform | Count |" >> dashboard.md
          echo "|----------|-------|" >> dashboard.md
          echo "| ðŸŸ¡ LeetCode | $lc_count |" >> dashboard.md
          echo "| ðŸ”µ Programmers | $pr_count |" >> dashboard.md
          echo "| ðŸŸ¢ Baekjoon | $bj_count |" >> dashboard.md
          echo "| ðŸ”¢ Total | $((lc_count+pr_count+bj_count)) |" >> dashboard.md
          echo "" >> dashboard.md

          echo "## ðŸ¥‡ Recently Solved (Top 5)" >> dashboard.md
          echo "" >> dashboard.md
          echo "$recent_top" >> dashboard.md
          echo "" >> dashboard.md

      ####################################################
      # ðŸ“¥ README ì‚½ìž…
      ####################################################

      - name: Insert into README
        run: |
          awk '
          BEGIN{flag=0}
          /<!-- DASHBOARD-START -->/{flag=1; print; system("cat dashboard.md"); next}
          /<!-- DASHBOARD-END -->/{flag=0}
          !flag
          ' README.md > README.new
          mv README.new README.md

      ####################################################
      # ðŸ’¾ Commit
      ####################################################

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "ðŸš€ auto: simplified dashboard"
          git push