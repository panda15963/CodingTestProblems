name: Auto Update README Dashboard

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate dashboard
        run: |
          # =============================
          # í”Œëž«í¼ë³„ ë¬¸ì œ ìˆ˜ ì¹´ìš´íŠ¸ (í•œê¸€ í´ë”ëª… ì§€ì›)
          # =============================

          lc_count=0
          pr_count=0
          bj_count=0

          [ -d "leetcode" ] && lc_count=$(find leetcode -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          [ -d "í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤" ] && pr_count=$(find í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤ -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          [ -d "ë°±ì¤€" ] && bj_count=$(find ë°±ì¤€ -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)

          total=$((lc_count + pr_count + bj_count))

          recent=$(git log --since="7 days ago" --name-only --pretty=format: \
            | grep "/" \
            | cut -d/ -f1 \
            | sort -u \
            | wc -l || echo 0)

          # =============================
          # Dashboard ìƒì„±
          # =============================

          echo "## ðŸ“Š Problem Dashboard" > dashboard.md
          echo "" >> dashboard.md
          echo "- ðŸŸ¡ LeetCode: $lc_count" >> dashboard.md
          echo "- ðŸ”µ Programmers: $pr_count" >> dashboard.md
          echo "- ðŸŸ¢ Baekjoon: $bj_count" >> dashboard.md
          echo "" >> dashboard.md
          echo "**Total Problems: $total**" >> dashboard.md
          echo "" >> dashboard.md
          echo "**Solved in last 7 days: $recent**" >> dashboard.md
          echo "" >> dashboard.md
          echo "---" >> dashboard.md
          echo "" >> dashboard.md
          echo "## ðŸ“Œ All Problems" >> dashboard.md
          echo "" >> dashboard.md
          echo "| Platform | Problem | Link |" >> dashboard.md
          echo "|----------|---------|------|" >> dashboard.md

          # =============================
          # ìµœì‹ ìˆœ ì •ë ¬
          # =============================

          if [ -d "leetcode" ]; then
            for dir in $(ls -dt leetcode/* 2>/dev/null); do
              [ -d "$dir" ] && echo "| LeetCode | $(basename "$dir") | [ðŸ”—](./$dir) |" >> dashboard.md
            done
          fi

          if [ -d "í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤" ]; then
            for dir in $(ls -dt í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤/* 2>/dev/null); do
              [ -d "$dir" ] && echo "| Programmers | $(basename "$dir") | [ðŸ”—](./$dir) |" >> dashboard.md
            done
          fi

          if [ -d "ë°±ì¤€" ]; then
            for dir in $(ls -dt ë°±ì¤€/* 2>/dev/null); do
              [ -d "$dir" ] && echo "| Baekjoon | $(basename "$dir") | [ðŸ”—](./$dir) |" >> dashboard.md
            done
          fi

      - name: Insert into README
        run: |
          awk '
          BEGIN{flag=0}
          /<!-- DASHBOARD-START -->/{flag=1; print; system("cat dashboard.md"); next}
          /<!-- DASHBOARD-END -->/{flag=0}
          !flag
          ' README.md > README.new

          mv README.new README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "ðŸ“Š auto: update dashboard (Korean folder support)"
          git push